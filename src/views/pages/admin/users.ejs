<link rel="stylesheet" href="/css/admin.css">

<div class="admin-container">
  <!-- Admin Header -->
  <header class="admin-header">
    <h1>ğŸ‘¥ User Management</h1>
    <nav class="admin-nav">
      <a href="/admin">Dashboard</a>
      <a href="/admin/users" class="active">Users</a>
      <a href="/admin/threads">Threads</a>
      <a href="/admin/cache">Cache</a>
      <a href="/">â† Back to Forum</a>
    </nav>
  </header>

  <!-- Search Bar -->
  <div class="admin-search">
    <form action="/admin/users" method="GET" class="search-form">
      <input 
        type="text" 
        name="search" 
        placeholder="Search by username, email, or display name..." 
        value="<%= searchQuery || '' %>"
        class="search-input"
      >
      <% if (currentRole) { %>
        <input type="hidden" name="role" value="<%= currentRole %>">
      <% } %>
      <button type="submit" class="search-btn">ğŸ” Search</button>
      <% if (searchQuery) { %>
        <a href="/admin/users<%= currentRole ? '?role=' + currentRole : '' %>" class="clear-search-btn">âœ• Clear</a>
      <% } %>
    </form>
  </div>

  <!-- Filters -->
  <div class="admin-filters">
    <a href="/admin/users<%= searchQuery ? '?search=' + encodeURIComponent(searchQuery) : '' %>" class="filter-btn <%= !currentRole ? 'active' : '' %>">
      All Users (<%= totalUsers %>)
    </a>
    <a href="/admin/users?role=user<%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %>" class="filter-btn <%= currentRole === 'user' ? 'active' : '' %>">
      Users
    </a>
    <a href="/admin/users?role=moderator<%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %>" class="filter-btn <%= currentRole === 'moderator' ? 'active' : '' %>">
      Moderators
    </a>
    <a href="/admin/users?role=admin<%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %>" class="filter-btn <%= currentRole === 'admin' ? 'active' : '' %>">
      Admins
    </a>
  </div>

  <!-- Users Table -->
  <section class="admin-panel">
    <div class="panel-content">
      <% if (users && users.length > 0) { %>
        <table class="admin-table full-width">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% users.forEach(user => { %>
              <tr class="<%= !user.isActive ? 'inactive-row' : '' %>">
                <td>#<%= user.id %></td>
                <td>
                  <a href="/profile/<%= user.username %>"><%= user.displayName || user.username %></a>
                </td>
                <td><%= user.email %></td>
                <td>
                  <form action="/admin/users/<%= user.id %>/role" method="POST" style="display: inline;">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <select name="role" onchange="this.form.submit()" class="role-select">
                      <option value="user" <%= user.role === 'user' ? 'selected' : '' %>>User</option>
                      <option value="moderator" <%= user.role === 'moderator' ? 'selected' : '' %>>Moderator</option>
                      <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>Admin</option>
                    </select>
                  </form>
                </td>
                <td>
                  <% if (user.isBanned) { %>
                    <span class="status-badge banned" title="<%= user.banReason || 'No reason provided' %>">ğŸš« Banned</span>
                  <% } else if (user.isActive) { %>
                    <span class="status-badge active">âœ… Active</span>
                  <% } else { %>
                    <span class="status-badge inactive">ğŸ’¤ Inactive</span>
                  <% } %>
                </td>
                <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                <td class="action-buttons">
                  <a href="/admin/users/<%= user.id %>/edit" class="btn-icon" title="Edit User">
                    âœï¸
                  </a>
                  <% if (user.isBanned) { %>
                    <form action="/admin/users/<%= user.id %>/unban" method="POST" style="display: inline;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button type="submit" class="btn-icon" title="Unban User">
                        ğŸ”“
                      </button>
                    </form>
                  <% } else { %>
                    <form action="/admin/users/<%= user.id %>/ban" method="POST" style="display: inline;" onsubmit="const reason = prompt('Reason for banning this user:'); if (!reason) return false; this.querySelector('input[name=reason]').value = reason;">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input type="hidden" name="reason" value="">
                      <button type="submit" class="btn-icon" title="Ban User">
                        ğŸ”¨
                      </button>
                    </form>
                  <% } %>
                  <form action="/admin/users/<%= user.id %>/toggle-active" method="POST" style="display: inline;">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="btn-icon" title="<%= user.isActive ? 'Deactivate' : 'Activate' %>">
                      <%= user.isActive ? 'ğŸ’¤' : 'âœ…' %>
                    </button>
                  </form>
                  <form action="/admin/users/<%= user.id %>/delete" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="btn-icon danger" title="Delete User">
                      ğŸ—‘ï¸
                    </button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
          <div class="admin-pagination">
            <%
              let paginationParams = [];
              if (currentRole) paginationParams.push('role=' + currentRole);
              if (searchQuery) paginationParams.push('search=' + encodeURIComponent(searchQuery));
              const paramString = paginationParams.length > 0 ? '&' + paginationParams.join('&') : '';
            %>
            <% if (currentPage > 1) { %>
              <a href="?page=<%= currentPage - 1 %><%= paramString %>" class="pagination-btn">â† Previous</a>
            <% } else { %>
              <span class="pagination-btn disabled">â† Previous</span>
            <% } %>
            
            <span class="pagination-info">Page <%= currentPage %> of <%= totalPages %></span>
            
            <% if (currentPage < totalPages) { %>
              <a href="?page=<%= currentPage + 1 %><%= paramString %>" class="pagination-btn">Next â†’</a>
            <% } else { %>
              <span class="pagination-btn disabled">Next â†’</span>
            <% } %>
          </div>
        <% } %>
      <% } else { %>
        <p class="empty-state">No users found</p>
      <% } %>
    </div>
  </section>
</div>
